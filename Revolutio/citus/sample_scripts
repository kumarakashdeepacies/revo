#CITUS CONFIGURATION
#Access docker containers for citus-Go to folder with docker-compose file
docker-compose -f docker-compose-kubernetes.yml exec -it citusmaster psql -U revolutio
docker-compose -f docker-compose-kubernetes.yml exec -it citusworker-1 psql -U revolutio
docker-compose -f docker-compose-kubernetes.yml exec -it citusworker-2 psql -U revolutio

#Enable Citus - Run the following in all 3 containers
CREATE EXTENSION citus;
#Connect to database
\c <databasename>;
#Enable Citus - Run the following in all 3 containers
CREATE EXTENSION citus;

#Configure master slave - Run the following in the master container
SELECT citus_set_coordinator_host('citus_master', 5432);
SELECT * from citus_add_node('citus_worker_1', 5432);
SELECT * from citus_add_node('citus_worker_2', 5432);

#Check worker node status
SELECT * FROM citus_get_active_worker_nodes();

#SHARDING
#Create example table for sharding
CREATE TABLE wikipedia_editors (editor TEXT UNIQUE,bot BOOLEAN,edit_count INT,added_chars INT,removed_chars INT,first_seen TIMESTAMPTZ,last_seen TIMESTAMPTZ);
CREATE TABLE wikipedia_changes (editor TEXT,time TIMESTAMP WITH TIME ZONE,wiki TEXT,title TEXT,comment TEXT,minor BOOLEAN,type TEXT,old_length INT,new_length INT);

#Mark as distributed table
SELECT create_distributed_table('wikipedia_changes', 'editor', 'hash');
SELECT create_distributed_table('wikipedia_editors', 'editor', 'hash');

#WALG BACKUP
#Current implementation is only for Azure Storage. Archive mode should be switched on and the backup storage folder should be updated in docker compose ENV parameters.
ARCHIVE_MODE: "on"
WALG_AZ_PREFIX: "azure://datastoretesting/walg-worker-2"

#Trigger full backup. Run the following on all the citus containers
/wal-g backup-push /var/lib/postgresql/data

#WALG RESTORE
#The new citus containers where backup is to be restored, should started with archive mode switched off and with a backup volume
ARCHIVE_MODE: "off"
volumes:
  - citus-master-data-backup:/pgbackupdata

#Once the containers are up, enter the containers for master and workers and execute the following command to fetch LATEST backup files
/wal-g backup-fetch /pgbackupdata LATEST

#Once fetch is successful, go out of container to docker compose cli and activate recovery signal on the backup volume
docker exec citus_master touch /pgbackupdata/recovery.signal
docker exec citus_worker_1 touch /pgbackupdata/recovery.signal
docker exec citus_worker_2 touch /pgbackupdata/recovery.signal

#Now turn down the server and start citus containers with backup volume as primary citus storage volume
volumes:
  - citus-master-data-backup:/var/lib/postgresql/data



